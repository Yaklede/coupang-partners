# AGENTS.md

> 매일 쿠팡파트너스 상품 10~100개를 네이버 블로그에 자연스러운 한국어 글로 발행하는 자동화 시스템의 설계·프롬프트·운영 규칙.

---

## 0) 목표 & 핵심 지표

* **최상위 목표**: 네이버 블로그 품질을 해치지 않으면서(자연스러운 문체, 사람스러운 구성) 클릭/전환을 유도하는 상품 글을 **매일 10~100건** 안정적으로 발행.
* **핵심 KPI**

  * 게시 성공률 ≥ 99%

  * 중복 포스팅율 ≤ 0.5%

  * 포스트별 평균 체류시간, 스크롤 깊이(가능 시 추정) ↑

  * 클릭율(CTR)·전환율(CVR)·수익/게시글 ↑

  * AI-감지 표식(과도 반복, 빈약 요약, 톤 일관 과함 등) 경감 점수 ↑

  * **월 AI 비용 ≤ $20 (일 상한 ≈ $0.67), 포스트당 목표 단가: $0.0067 ~ $0.066**

  * 게시 성공률 ≥ 99%

  * 중복 포스팅율 ≤ 0.5%

  * 포스트별 평균 체류시간, 스크롤 깊이(가능 시 추정) ↑

  * 클릭율(CTR)·전환율(CVR)·수익/게시글 ↑

  * AI-감지 표식(과도 반복, 빈약 요약, 톤 일관 과함 등) 경감 점수 ↑

## 1) 범위 & 제약

* **플랫폼**: 네이버 블로그(Developer API 사용).
* **상품 소스**: 쿠팡파트너스(공식 API 미사용 시 합법적 범위 내의 웹 자동화/스크래핑).
* **법/정책 준수**: 각 플랫폼 **이용약관, robots.txt, 상표·저작권, 광고 표기** 준수.
* **콘텐츠 품질**: 자연스러운 한국어, 제품 맥락·경험담·비교·구매 팁 포함.
* **안전**: 민감·금지 카테고리(의약품 등) 자동 차단, 사실 검증 필터.

> ⚖️ **정책 가드레일**: 스크래핑/자동화는 트래픽·빈도·접속 방식에서 서비스 운영자에게 해가 되지 않도록 제한. 콘텐츠에는 **광고·추천 포함** 고지(표준 문구) 포함.

---

## 2) 전체 아키텍처 (멀티-에이전트)

```
[Scheduler] ──▶ [Product Miner] ──▶ [RAG Builder] ──▶ [Writer] ──▶ [Refiner]
     │                 │                 │                │            │
     │                 └─▶ [Deduper] ◀───┘                │            │
     │                                                   │            │
     └─▶ [Queue] ◀─────────────────────────────── [Policy Guard] ◀─────┘
                                                           │
                                  [SEO Optimizer] ──▶ [Publisher]
                                                           │
                                                   [Monitor/Feedback]
```

### 2.1 에이전트 역할

* **Scheduler**: 일/시간대별 작업량 분배(10~100건), 휴면시간·랜덤 지연 반영.
* **Product Miner**: 키워드→상품 후보 검색(카테고리/가격/할인/리뷰수 필터). 소스 메타 수집.
* **Deduper**: URL·쿠팡상품ID·해시로 중복 차단. 최근 90일 윈도우 유지.
* **RAG Builder**: 상품 상세·리뷰 요점·스펙 표·Q&A 요지 추출 → 구조화 컨텍스트(JSON) 생성.
* **Writer**: 사람스러운 초안 작성(문장 길이 분산, 구어체·서술체 혼합, 사례·비유·반박 포함).
* **Refiner**: 금지어·클레임 위험·과장제거, 중복패턴 제거, 어휘 다양성·리듬 조정.
* **SEO Optimizer**: 네이버 검색 최적화(제목/소제목/해시태그/본문 내부 앵커) 적용.
* **Policy Guard**: 광고표기·민감상품 필터·거짓·오표기 방지 룰.
* **Publisher**: 네이버 블로그 API 게시/수정/임시저장/미리보기.
* **Monitor/Feedback**: 게시 성공·지연·차단 원인 로깅, CTR/CVR 회귀 피드백.

### 2.2 데이터 파이프라인

1. 키워드 시드(트렌드·시즌성·랭킹) → 2) 상품 후보 수집 → 3) 정규화(타이틀·가격·옵션·평점·후기수) → 4) 중복/품질필터 → 5) RAG 컨텍스트 → 6) 초안/리라이트 → 7) SEO·가드 → 8) API 게시 → 9) 메트릭 집계.

---

## 3) 실행 환경 & 설정 예시

```yaml
app:
  target_posts_per_day: 3         # 10~100 범위 내 전략값
  burst_window_minutes: 90         # 한 번에 몰지 않도록 분산
  random_delay_sec: [15, 120]      # 호출 사이 랜덤 대기
  locale: ko_KR
  timezone: Asia/Seoul

cost:
  monthly_cap_usd: 20.0            # 한달 총 한도
  daily_cap_usd: 0.67              # 일일 상한 (20/30)
  per_post_target_usd:             # 포스트당 예산 표 (동적으로 계산해 사용)
    "10_per_day": 0.0667          # 300/월 기준
    "20_per_day": 0.0333
    "30_per_day": 0.0222
    "40_per_day": 0.0167
    "50_per_day": 0.0133
    "60_per_day": 0.0111
    "80_per_day": 0.0083
    "100_per_day": 0.0067

naver:
  blog_id: "YOUR_BLOG_ID"
  client_id: "${NAVER_CLIENT_ID}"
  client_secret: "${NAVER_CLIENT_SECRET}"
  access_token: "${NAVER_ACCESS_TOKEN}"
  rate_limit_per_min: 5

coupang:
  partner_referral_id: "YOUR_PARTNER_ID"  # 수익링크 파라미터
  user_agent_pool: ["...", "..."]
  crawl_interval_sec: [2, 6]
  max_products_per_keyword: 12

llm:
  provider: "openai"                # 예: openai / other
  models:
    writer: "SMALL_WRITER"          # 소형 모델 식별자(환경변수로 주입)
    refiner: "SMALL_EDITOR"
    seo: "SMALL_ASSIST"
  token_cap:                         # 하드 토큰 상한(초과 시 클라이언트에서 자르기)
    writer_in: 600
    writer_out: 550
    refiner_in: 900
    refiner_out: 0                   # 리파이너는 불필요 확장 금지(Δ토큰 ≈ 0)
    seo_in: 500
    seo_out: 150
  retry: {max: 2, backoff_sec: [5, 20]}

content:
  min_chars: 900
  max_chars: 2200
  image_min: 2
  image_max: 6
  include_disclosure: true
  tone_profile: "human_mix_v2"
  roundup:
    list_post_items_default: 5     # 라운드업 기본 5개
    list_post_items_min: 3         # 하한 3개
    list_post_items_max: 7         # 상한 7개
  link_policy:
    per_product_max: 1             # 제품별 본문 텍스트 링크 최대 1회
    final_cta_button: true         # 마지막 CTA 버튼 1회
    dedupe_same_url: "prefer_button"  # 동일 URL 중복 시 버튼만 남김

moderation:
  banned_categories: ["의약품", "성인용품", "주류", "니코틴", "의료기기"]
  fact_check:
    price_tolerance_pct: 5
    mandatory_fields: ["모델명", "주요스펙", "구성품"]

storage:
  db: postgres
  tables: [products, posts, keywords, runs, metrics]
```

---

## 4) 도구(툴) 인터페이스

### 4.1 네이버 블로그 Publisher(필수)

* 기능: 글 생성/수정/삭제, 임시저장, 카테고리/태그, 이미지 업로드, 본문 HTML 지원.
* 입력: `title`, `body_html`, `category_no`, `tags[]`, `visibility(draft|public)`.
* 출력: `post_id`, `url`, 상태코드.
* 예외: 인증만료, 레이트리밋, 금지어/필터.

### 4.2 쿠팡 Product Miner

* 기능: 키워드 검색→상품목록, 상세페이지 파싱, 제휴 파라미터 조립.
* 출력 필드 예: `product_id`, `title`, `price`, `sale_rate`, `rating`, `review_cnt`, `thumbs[]`, `detail_images[]`, `specs{...}`, `qna[]`, `reviews_snippets[]`, `deeplink`.
* 주의: 요청 빈도 제한, 헤더/지연, HTML 구조 변화 감지.

### 4.3 RAG 컨텍스트 스키마(JSON)

```json
{
  "product": {
    "id": "",
    "title": "",
    "brand": "",
    "category": ["소형가전", "가습기"],
    "price": 39900,
    "sale_rate": 0.18,
    "rating": 4.6,
    "review_cnt": 3124,
    "specs": {"용량": "2L", "소음": "28dB"},
    "pros": ["물세척 쉬움", "저소음 야간모드"],
    "cons": ["물때 관리 필요"],
    "best_for": ["원룸", "아기방 야간"],
    "images": ["..."],
    "deeplink": "https://...partner=YOUR_PARTNER_ID"
  },
  "compares": [ {"title":"경쟁모델A", "diff":"가격↑, 용량↑"} ],
  "tips": ["필터 주 1회 세척"],
  "seasonality": "겨울 가습 수요↑",
  "faq": [
    {"q":"소음 큰가요?", "a":"야간모드 28dB로 정숙"}
  ]
}
```

---

## 5) 프롬프트 설계 ("AI 느낌 제거" 중심)

### 5.1 공통 원칙

* **가변 리듬**: 문장 길이·구조 다양화(짧은 도치, 중간 길이, 길게 설명 섞기).
* **작은 경험담**: “원룸에서 써보니…”, “부모님 댁에 놓아보면…” 같은 **상황 기반 평가**.
* **제한적 추측**: 추정은 근거 제시(“리뷰 3천+ 기준으로 보면…”).
* **미묘한 결함 언급**: 단점 1~2개를 구체적으로. 신뢰감↑.
* **한국어 자연화**: 과잉 접속사, ‘전반적으로’·‘종합적으로’ 반복 금지. 조사 변화.
* **하드 금지**: 과장 광고(의학·성능 보장), 타사 비방, 허위 사실.

### 5.2 시스템 프롬프트(Writer)

```text
역할: 당신은 한국어 쇼핑 블로거입니다. 사람처럼 씁니다. 광고임을 숨기지 않되 과장하지 않습니다.
규칙:
1) 입력 JSON의 사실만 사용.
2) 한 문단에 2~4문장, 문장 길이 다양화. 반복어구 금지.
3) 단점 1~2개, 관리 팁 1개 이상 포함.
4) 개인적 맥락 1회: "원룸/아이방/반려동물" 등 상황 가정.
5) 이해를 돕는 비교 1회(동급/이전 모델 차이). 욕설·과장은 금지.
6) 끝에 투명 고지문과 제휴 링크 버튼 문구 포함.
출력: 네이버 블로그용 HTML(강조는 <strong>, 소제목은 <h3>). 표는 <table> 사용.
어조: 담백, 생활감 있는 한국어, 리뷰어 톤.
```

### 5.3 사용자 프롬프트 템플릿(Writer)

```text
[컨텍스트]
{{RAG_JSON}}

[생성 지시]
- 제목: 35자 내외, 검색 의도 반영, 모델명 노출 가급적 1회.
- 도입: 문제상황→제품 해결 포인트 2줄.
- 본문: 장점(2~3), 단점(1~2), 사용팁(1~2), 간단 비교(1), 핵심 스펙 표(있으면).
- 마무리: 어떤 사람에게 맞는지, 주의점 1줄.
- CTA: "자세히 보기" 링크 버튼(제휴 링크 주입).

[제약]
- 의학적·법적 효능 금지, 과도한 이모지 금지(총 0~2개), 영어 남용 금지.
- 문장 길이 다양화(짧은 문장 20~30%), 문체 혼합(서술체/구어체 7:3).
```

### 5.4 리라이팅(Refiner) 프롬프트

```text
역할: 텍스트 에디터. AI 흔적(상투적 연결어, 과한 매끈함)을 줄이고 한국어 생활 감각을 살립니다.
작업:
- 반복 어구·문장 구조 치환.
- 조사·접속사 다양화(하지만/그런데/다만/그래도 등 분산).
- 근거 없는 절대 표현 축소(최고, 완벽, 필수 등 피하기).
- 단락 첫 문장에 미세 훅 추가(경험·상황).
반환: HTML 보존, 의미 불변.
```

### 5.5 SEO 최적화 프롬프트

```text
입력: 게시 전 HTML, 키워드 리스트.
작업:
- H2/H3 소제목에 롱테일 키워드 1~2개 자연 삽입.
- 본문 초반 150자에 핵심 키워드 1회.
- 메타 설명 80~110자 생성(한국어).
- 해시태그 6~10개(일반+롱테일 믹스).
- 키워드 과밀도 2% 이하 유지.
반환: title, description, hashtags[], 개선된 HTML.
```

### 5.6 광고 표기(자동 삽입)

```html
<p style="font-size:12px;color:#777">* 이 글에는 쿠팡 파트너스 활동을 통해 일정액의 수수료를 제공받을 수 있는 링크가 포함되어 있습니다.</p>
```

---

## 6) 본문 HTML 스캐폴딩

### 6.0 라운드업 운영 규칙(요약)

* 기본 **5개/포스트**, 허용 범위 **3–7개**.
* 각 제품 섹션: 미니리뷰 80–120자 + 스펙 한 줄 + **CTA 1개**.
* **링크 1회 원칙**: 제품별 텍스트 링크 ≤1, 마지막에 통합 CTA 버튼 1. 동일 URL이면 버튼만 남김.

```html
<h2>{{title}}</h2>
<p>{{intro_problem}}<br>{{intro_solution}}</p>

<h3>이 제품, 이런 점이 좋았어요</h3>
<ul>
  <li>{{pro1}}</li>
  <li>{{pro2}}</li>
  <li>{{pro3_optional}}</li>
</ul>

<h3>써보니 아쉬웠던 부분</h3>
<ul>
  <li>{{con1}}</li>
  <li>{{con2_optional}}</li>
</ul>

<h3>간단 비교</h3>
<p>{{compare_summary}}</p>

<h3>핵심 스펙</h3>
<table>
  <tr><th>항목</th><th>내용</th></tr>
  {{#each specs}}
  <tr><td>{{key}}</td><td>{{value}}</td></tr>
  {{/each}}
</table>

<h3>사용 팁</h3>
<ul>
  <li>{{tip1}}</li>
  <li>{{tip2_optional}}</li>
</ul>

<p><a href="{{deeplink}}" target="_blank" rel="nofollow">자세히 보기</a></p>
{{disclosure}}
```

---

## 7) 품질·안전 체크리스트

* [ ] 금지 카테고리/금지어 없음
* [ ] 허위·확정적 표현 없음(“완치”, “보장” 등)
* [ ] 동일/유사 문단 반복 없음(3문장 이상 유사도 체크)
* [ ] 스펙·가격 최신성 검토(±5%)
* [ ] 이미지 저작권·출처 안전
* [ ] 광고표기 문구 포함
* [ ] 딥링크 파라미터 정확
* [ ] 문장 길이/구조 다양성 기준 충족(짧은 문장 비율≥20%)
* [ ] 초안→Refine→SEO→최종 순서 준수
* [ ] **링크 1회 원칙** 준수(제품별 텍스트 링크 ≤1, 최종 CTA 버튼 1, 동일 URL 중복 제거)
* [ ] **라운드업 제품 개수**: 3–7개 범위, 기본 5개

---

## 8) 스케줄링 전략

* **네이버 안전 권장 주기(권고)**: 하루 **1~3건**을 기본으로, 글 사이 **≥3시간 간격** 유지. 초기 2주 관찰 후 성과·제재 여부에 따라 **최대 5건/일**까지 점진 확대.

  * 공식 가이드에 명시된 수치 상한은 없으나, 대량·반복 게시나 짧은 시간 내 연속 발행은 **도배/스팸**으로 의심되어 제재될 수 있음(운영정책 및 SEO 기본 원칙 참고).
* 게시 시간 분산: 출퇴근/점심/야간 테스트 후 상위 시간대에 50% 배정.
* 하루 1~5건을 **키워드 버킷**별 균등(가전/키친/리빙/디지털 등).
* **콘텐츠 믹스(초기 4주)**: 단일 리뷰 **60%**, 라운드업 **40%**(라운드업은 기본 **5개/포스트**, 3–7개 범위).
* 계절성 키워드 가중치(예: 10~2월 가습기↑, 4~6월 제습기↑).

---

## 9) 중복·유사도 제어

* `product_id`+옵션 조합 해시 보관, 90일 내 재게시 금지.
* 생성 결과 문장 임베딩 유사도(코사인) 0.92 이상이면 리라이트 재시도.
* 템플릿 슬롯 셔플: 소제목·문장 스타터·접속사 풀에서 샘플링.

---

## 10) 로깅/추적 & 피드백 학습

* 단위 로그: 키워드→상품ID→초안해시→Refine해시→게시ID→URL.
* 지표 저장: 노출/클릭/전환(가능 범위), 조회수, 체류 추정.
* 주간 AB 실험: 제목 톤(정보형 vs 호기심형), 소제목 구조, 길이.
* 실패 사인: 인증 만료, 레이트리밋, API 오류, 본문 금지어 히트 → 재시도 정책.

---

## 11) 에이전트 간 계약(Contract)

* 입력/출력 스키마 고정(JSON Schema 관리).
* 실패 시 재시도 최대 3회, 지수적 백오프.
* 각 단계는 **idempotent**: 동일 입력이면 동일 출력(해시로 보장).

---

## 12) 보안·비밀정보 관리

* API 키는 `.env`/비밀 저장소. 로그에 노출 금지.
* 포스트 본문에 토큰/키가 삽입되지 않도록 LLM 프롬프트에 명시 차단.

---

## 13) 예시 프롬프트 세트

### 13.1 제목 생성(다양성 강조)

```text
다음 제품 요약을 읽고, 검색 의도형/효익 강조형/상황 공감형 3가지를 생성.
- 길이: 26~38자, 느낌표 남용 금지.
- 모델명은 1회 이하.
입력: {{RAG_JSON.product}}
출력: title_options[3]
```

### 13.2 한 줄 도입 훅(3안)

```text
제품이 해결하는 구체적 불편을 1문장으로. 일상어.
예: "겨울밤, 가습기 물 보충 때문에 자주 깨셨나요?"
```

### 13.3 비교 요약 생성

```text
동급 상위 1개와 비교해 차이를 2문장으로 공정하게 요약.
- 과장 금지, 근거는 RAG의 스펙만.
```

---

## 14) 실패 대응 런북

* 401/403: 토큰 재발급 후 2분 대기 재시도.
* 429(레이트): 헤더 기반 리밋 잔여 확인→대기→큐 재삽입.
* 415/422(본문 이슈): 금지어/HTML 태그 검사→Refine 재실행.
* 5xx: 1, 3, 5분 간격 3회 재시도.

---

## 15) 운영 체크리스트 (매일)

* [ ] API 토큰 만료일 확인
* [ ] 게시 실패 큐 비움
* [ ] CTR/CVR 상위/하위 10% 리뷰
* [ ] 금지 카테고리 신설 여부 점검
* [ ] 키워드 시드 갱신(트렌드/계절)

---

## 16) 오픈 이슈(결정 필요 — 체크 후 운영 반영)

* [ ] 네이버 공개범위 전략(바로공개 vs 임시저장→수동검수)
* [ ] 카테고리 맵핑 표(블로그 카테고리번호 ↔ 상품 카테고리)
* [ ] 이미지 소스 정책(쿠팡 썸네일 vs 자체 캡처/합성)
* [ ] 가격 변동 민감도(±5% 초과 시 자동 수정 여부)
* [ ] 10~100건 배분비(시간대/카테고리/신상품 비중)

---

## 17) 샘플 결과(요약)

* 제목: “원룸 가습, 밤에도 조용한 2L 저소음 가습기 써보니”
* 도입 훅: “겨울밤, 가습기 물 보충 때문에 자주 깨셨나요?”
* 본문: 장점 3, 단점 1, 사용팁 1, 비교 1, 스펙 표 1.
* CTA: “자세히 보기” 링크 버튼 + 광고표기 문구.

---

### 부록 A) 네이버 API 포스팅 요청 스켈레톤 (의사코드)

```kotlin
val post = NaverPost(
  title = title,
  body = html,
  categoryNo = category,
  tags = tags,
  visibility = "PUBLIC" // or TEMP
)
naverClient.createPost(post)
```

### 부록 B) 딥링크 조립 규칙

```
base_url + "?src=blog&partner=YOUR_PARTNER_ID&keyword=" + urlEncode(keyword)
```

### 부록 C) 금지 표현 샘플

* “완치/치료/100% 보장/의학적 효능”
* “최고/완벽/무조건 사세요” (근거 없이 절대화)

---

## 18) 비용 가드레일 & 모델 전략 (월 $20 한도)

### 18.1 예산 분해

* 월 한도: **$20** ⇒ 일일 상한: **$0.67**(30일 기준)
* 포스트당 목표 단가(대략):

  * 10개/일 → $0.0667, 20개/일 → $0.0333, 60개/일 → $0.0111, 100개/일 → $0.0067

### 18.2 파이프라인 절감 정책

1. **하이브리드 생성**: 중요도 점수 상위 20%만 LLM 전과정(Writer→Refiner→SEO), 하위 80%는 **규칙+템플릿+동의어 사전**으로 작성 후 **Refiner만 조건부**(유사도>0.92일 때만).
2. **캐시 우선**: 동일/유사 상품은 **RAG 요약 캐시** 재사용, 가격·스펙 변동이 없으면 초안 재생성 금지.
3. **프롬프트 압축**: RAG JSON에서 **필수 키만** 전달(제목/스펙/핵심 장단점/딥링크). 불필요 후기전문 미전달.
4. **토큰 상한**: 섹션별 `token_cap` 강제. 초안 길이 자동 단축(짧은 문장 비율 정책으로 보정).
5. **모델 경량화**: 세 역할(Writer/Refiner/SEO) 모두 **소형 모델** 기본값. 대형 모델은 장애 복구·AB 실험 때만.
6. **배치 작업**: 제목 후보·해시태그는 **N건 묶음 생성**으로 호출 횟수 최소화.
7. **얼리 스톱**: 품질 검사 통과 시 Refiner/SEO 생략. (금지어·유사도·문장다양성 통과)
8. **일일 게이트**: 일 상한 $0.67 도달 시 잔여 작업은 **템플릿 모드**로 전환(LLM 호출 없이 발행) 또는 다음날로 이월.

### 18.3 비용 모니터링

* **실시간 추정기**: `llm.pricing.{model}.(input_per_mtok, output_per_mtok)` 환경변수로 단가 주입 → 호출 전
  a priori 비용 계산, 호출 후 토큰 사용량으로 a posteriori 정산.
* **경보**: 일 예산 70%·90%·100% 구간별 경고 및 자동 정책 전환(18.2-8).

### 18.4 품질 유지 장치(저예산 모드)

* 템플릿 슬롯에 **짧은 경험담/비교/팁**을 규칙 기반으로 주입(랜덤화+사전구 포함)하여 기계적 톤 최소화.
* 상·하위 10% 성과 포스트만 **주간 재리라이팅**(LLM 사용)으로 품질 집중 투자.

---

> 본 문서는 팀 내 운영 표준입니다. 수정 시 PR로 리뷰하고, 프롬프트/룰 변경은 실험 결과와 함께 기록하십시오.

